<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stockbuddy Tasklist</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet">

	<style>
	h1{
		font-family:'Ubuntu Mono', monospace;
		font-size: 24pt;
		font-weight: bolder;
		text-align: center;
	}
	h2{
		font-family:'Ubuntu Mono', monospace;
		font-size: 20pt;
		font-weight: bold;
		text-align: center;
	}
	.stockbuddybutton {
		display:block;
		width:100px;
		margin:0px;
		float:left;
		text-align:center;
		height:100px;
		line-height:100px;
		cursor: pointer;
	}
	.sbcol2 {
		text-align:right;
	}
	.topbuttons{
		width:100%;
		position:absolute;
		top:0px;
		z-index:4
	}
	.topbuttons .btn{
		width:100%
	}	
	.topbuttons td{
		width:33.33%
	}	
	.topbuttons .secondrow{
		display:table-row;
	}
	#additiondiv{
		display:none
	}
	.addition {
		width:300px;
		margin:auto;
		padding-top:36px;
	}
	</style>
  </head>
  <body  onload="bodyload()">
	<table class="topbuttons">
		<tr class="firstrow">
			<td><button type="button" class="btn btn-outline-dark sb_switchbtn" switchclass="btn-dark" unswitchclass="btn-outline-dark" onclick="switchBtn()"></button></td>
			<td><button type="button" id="listselect" class="btn btn-outline-light" onclick="loadTasks(prompt('List name?'))">Load</button></td>
			<td><button type="button" id="filterBtn" class="btn btn-outline-light sb_switchbtn" switchclass="btn-info" unswitchclass="btn-outline-light" onclick="switchBtn()">Filter</button></td>
		</tr>
	</table>
	
	<div id="checklistContainer" class="bd-example m-0 border-0">
		<!----
		<table><tr class="alert alert-primary alert-dismissible fade show" role="alert"  style="height:32pt;"><td>
			  A simple primary alert with <a href="#" class="alert-link">an example link</a>. Give it a click if you like.
			</td><td>
			  Time to start
			</td>
			<td><p class="spacer" style="width:40px"></p></td>
			<td>
			 <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="top:-8px;right:-8px;"></button>
			</td></tr></table>
			---->
		<!----
		<div class="list-group">
			  <a class="list-group-item list-group-item-action list-group-item-primary">A simple primary list group item</a>
			  <a class="list-group-item list-group-item-action list-group-item-info">A simple info list group item</a>
			</div>
		</div>
			---->
			
	<h1 id="listname">default</h1>
		<div class="list-group" id="checklist">         
			<h2>LOADING</h2>
		</div>
		<div style="width:200px;margin-right:auto;margin-left:auto;padding:0px;height:100px;;">
		<div class="list-group-item list-group-item-action list-group-item-info stockbuddybutton" onclick="document.getElementById('additiondiv').style.display='block';document.getElementById('uid').value=new Date().getTime()">Add</div>
		<div class="list-group-item list-group-item-action list-group-item-info stockbuddybutton" >Manage</div>
		</div>
    </div>
	<div  id ="additiondiv"  class="addition">
		<table id ="additiontable" class="addition">
			<tr style="display:none">
				<td class="sbcol1">UID</td>
				<td class="sbcol2"><input type="textbox" id="uid" /></td>
			</tr>
			<tr>
				<td class="sbcol1">Task</td>
				<td class="sbcol2"><input type="textbox" id="task" /></td>
			</tr>
			<tr>
				<td class="sbcol1">Start Time</td>
				<td class="sbcol2"><input type="time" id="starttime"/></td>
			</tr>
			<tr>
				<td class="sbcol1">End Time</td>
				<td class="sbcol2"><input type="time" id="endtime" /></td>
			</tr>
			<tr>
				<td class="sbcol1">Label</td>
				<td class="sbcol2"><input type="textbox" id="category" /></td>
			</tr>
		</table>
		<div style="width:200px;margin-right:auto;margin-left:auto;padding:0px;height:100px;;">
			<div class="list-group-item list-group-item-action list-group-item-info stockbuddybutton" onclick="addTask()">Add</div>
			<div class="list-group-item list-group-item-action list-group-item-danger stockbuddybutton" onclick="clear_addTask()">Cancel</div>
		</div>
		</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
	<script  type="text/javascript">	
	
	const checklistTemplate = '<div class="list-group-item list-group-item-action">A simple primary list group item</div>'
	
	var tasks = [];
	var lists = new Map();
	const config  = {
			"customcss":"",
			"customjs":"",
			"customhtml":"",
			"sortbyprio":true	
		}
	
	class StockBuddyTask {
		constructor(text,starttime,endtime,label,state,creationstamp=new Date().getTime(),parent=null) {
			if(text!=""){
				this.text = text;
				this.starttime = starttime;
				this.endtime = endtime;
				this.label = new StockBuddyLabelStyle(label);
				this.state=state ;
				tasks.push(this);
				this.subtasks=[];
				this.parent=parent;
				if(creationstamp!=0){
					this.creationstamp=creationstamp
				}else{
					this.creationstamp=new Date().getTime()				
				}
			}
		}
		serialize(){
			this.state=this.checkbox.value
			return JSON.stringify(this, ["text","starttime","endtime","label","state","style","creationstamp"])
		}
		static deserialize(string){
			return JSON.parse(string);
		}
		updatePrio(){
			this.score  = 2;
			var date = new Date()
			var timestring  = date.getHours().toString().padStart(2, '0')+":"+date.getMinutes().toString().padStart(2, '0')
			if(this.endtime ==""){
				this.score=2
			}
			else if(this.endtime < timestring){
				this.score=4
			}		
			else{
				this.score=2
			}
			if(this.starttime ==""){
			}
			else if(this.starttime >timestring){
				this.score=1
			}

			
			if(this.state){
				this.score=0
			}
		}
		setDisplay(){
			this.label.style=StockBuddyLabelStyle.styles[this.score]
		
		}
	}
	function switchBtn(event) {

		if (!event) {
			event = window.event; // Older versions of IE use 
								  // a global reference 
								  // and not an argument.
		};

		var btn = (event.target || event.srcElement); // DOM uses 'target';
													 // older versions of 
													 // IE use 'srcElement'
		var val=btn.className.includes(btn.getAttribute("switchclass"))
		
		if(val){
			btn.className = "btn "+btn.getAttribute("unswitchclass")+" sb_switchbtn";
		}else{
			btn.className = "btn "+btn.getAttribute("switchclass")+" sb_switchbtn";	
		}
		btn.switched=!val
		if(btn.switchHandler==null){
			showFilterGroup(btn)
		}
		else{
			btn.switchHandler(btn)
		}
		var allBtns= btn.parentElement.parentElement.children[0].children
		for(let i = allBtns.length-1; i >-1;i--){
			if(allBtns[i]==btn) continue;
			if(allBtns[i].loseFocus!=null){
				allBtns[i].loseFocus(allBtns[i])
			}
		}
		displayTasks();
	}
	function showFilterGroup(btn){
		if(btn.parentElement.parentElement.className!="firstrow"){
			return;
		}
		var secondrows = document.getElementsByClassName("topbuttons")[0].getElementsByClassName("secondrow")
		if(btn.innerText!="Filter"||btn.switched==null){
			for(let i = secondrows.length-1; i  >-1; i--){
				secondrows[i].remove()
			}
			return;
		}
		if(btn.switched){
			var row1 = btn.parentElement.parentElement.parentElement.appendChild(document.createElement("tr"))	
			var col1 = row1.appendChild(document.createElement("td"))	
			var col2 = row1.appendChild(document.createElement("td"))	
			var col3 = row1.appendChild(document.createElement("td"))	
			
			row1.className = "secondrow";
			
			var btn1 = col1.appendChild(document.createElement("button"))	
			var btn2 = col2.appendChild(document.createElement("button"))	
			var btn3 = col3.appendChild(document.createElement("button"))	
			
			btn1.setAttribute("type","button")
			btn1.scorefilter=4
			btn1.innerText="Late"
			btn1.className="btn sb_switchbtn btn-smb btn-outline-light"
			btn1.setAttribute("switchclass",StockBuddyLabelStyle.buttonstyles[btn1.scorefilter])
			btn1.setAttribute("unswitchclass","btn-outline-light")
			
			btn2.setAttribute("type","button")
			btn2.scorefilter=2
			btn2.innerText="Ready"
			btn2.className="btn sb_switchbtn btn-smb btn-outline-light"
			btn2.setAttribute("switchclass",StockBuddyLabelStyle.buttonstyles[btn2.scorefilter])
			btn2.setAttribute("unswitchclass","btn-outline-light")
			
			btn3.setAttribute("type","button")
			btn3.scorefilter=1
			btn3.innerText="Waiting"
			btn3.className="btn sb_switchbtn btn-smb btn-outline-light"
			btn3.setAttribute("switchclass",StockBuddyLabelStyle.buttonstyles[btn3.scorefilter])
			btn3.setAttribute("unswitchclass","btn-outline-light")
			
			btn1.onclick=switchBtn
			btn2.onclick=switchBtn
			btn3.onclick=switchBtn
			//
			
			row1 = btn.parentElement.parentElement.parentElement.appendChild(document.createElement("tr"))	
			col1 = row1.appendChild(document.createElement("td"))	
			col2 = row1.appendChild(document.createElement("td"))	
			col3 = row1.appendChild(document.createElement("td"))	
			
			row1.className = "secondrow";
			
			btn2 = col2.appendChild(document.createElement("button"))	
			btn2.setAttribute("type","button")
			btn2.scorefilter=0
			btn2.innerText="Done"
			btn2.className="btn sb_switchbtn btn-smb btn-outline-light"
			btn2.setAttribute("switchclass",StockBuddyLabelStyle.buttonstyles[btn2.scorefilter])
			btn2.setAttribute("unswitchclass","btn-outline-light")
			
			btn2.onclick=switchBtn
			
			//btn3.setAttribute("type","button")
			//btn3.innerText="TEST"
			//btn3.className="btn btn-secondary sb_switchbtn btn-sm"
			
		}else{
			for(let i = secondrows.length-1; i  >-1; i--){
				secondrows[i].remove()
			}
		}
		document.getElementById("checklistContainer").style.paddingTop=
			(document.getElementsByClassName("topbuttons")[0].getClientRects()[0].height+5).toString()+"px"
		
		
	}
	class StockBuddyLabelStyle {
	  static styles = ["list-group-item-secondary","list-group-item-light","list-group-item-success","list-group-item-warning","list-group-item-danger"]
	  static buttonstyles = ["btn-secondary","btn-light","btn-success","btn-warning","btn-danger"]
	  constructor(label) {
		if(typeof label === 'string'){
			this.text = label;
			this.style = "list-group-item-primary"
			
				//"list-group-item-danger"
				//"list-group-item-warning"
				//"list-group-item-success"
		}
		else{
			this.text = label.text;
			this.style = label.style;		
		}
	  }
	}
	function updateTask(task,i){
			 task.div = document.getElementById("checklist").appendChild(document.createElement("div"))
			 task.div.id="task:"+i+":"+task.creationstamp
			 task.div.style.padding="5px"
			 task.checkdiv = task.div.appendChild(document.createElement("div"))
			 task.checkdiv.className = "form-check form-switch";
			 task.checkdiv.style.padding="5px"
			 task.checkdiv.style.float="left"
			 task.checkbox = task.checkdiv.appendChild(document.createElement("input"))
			 task.checkbox.setAttribute("type",'checkbox')
			 task.checkbox.setAttribute("role",'switch')
			 task.checkbox.className = "form-check-input";
			 task.checkbox.style.margin="5px"
			 task.checkbox.checked=task.state
			 task.checkbox.onclick = Function(`
				tasks[parseInt(("`+task.div.id+`").split(':')[1])].state = document.getElementById("`+task.div.id+`").getElementsByTagName("input")[0].checked;
				saveTasks()
				displayTasks()
			 `)
			 task.tasktext=task.checkdiv.appendChild(document.createElement("span"))
			 task.tasktext.style.display="inline-block"
			 task.tasktext.style.width="auto"
			 task.tasktext.innerText=task.text
			 task.taskrighthand=task.div.appendChild(document.createElement("div"))
			 task.taskstart=task.taskrighthand.appendChild(document.createElement("div"))
			 task.taskstart.style.display="inline-block"
			 task.taskstart.style.width="50px"
			 task.taskstart.innerText=task.starttime
			 task.taskend=task.taskrighthand.appendChild(document.createElement("div"))
			 task.taskend.style.display="inline-block"
			 task.taskend.style.width="50px"
			 task.taskend.innerText=task.endtime
			 task.taskdelete=task.taskrighthand.appendChild(document.createElement("div"))
			 task.taskdelete.style.display="inline-block"
			 task.taskdelete.style.width="80px"
			 task.taskdelete.innerText="Delete"
			 task.taskdelete.className = "list-group-item list-group-item-action list-group-item-danger";
			 task.taskdelete.setAttribute("state",false)
			 task.taskdelete.onclick = Function(`
				tasks.splice(parseInt(("`+task.div.id+`").split(':')[1]), 1)
				saveTasks()
				displayTasks()
			 `)
			 task.taskrighthand.style.float="right"
			 task.setDisplay()
			 task.div.className = "list-group-item list-group-item-action "+task.label.style;
			 
		}
	function displayTasks(){	
		document.getElementById("checklistContainer").style.paddingTop=(document.getElementsByClassName("topbuttons")[0].getClientRects()[0].height+5).toString()+"px"
		document.getElementById("checklist").innerHTML=""
		var i = 0
		var scores  = new Map();
		scores.set(-1, []);
		scores.set(0, []);
		scores.set(1, []);
		scores.set(2, []);
		scores.set(3, []);
		scores.set(4, []);
		var filterSettingRows = document.getElementsByClassName("secondrow")
		for(var  j  =  0;  j  < filterSettingRows.length;j++){
			var filterbutton = filterSettingRows[j].getElementsByTagName("button")
			for(var  k  =  0;  k  < filterbutton.length;k++){
				if(filterbutton[k]!=null&& filterbutton[k].switched){
					scores.delete(filterbutton[k].scorefilter);
				}
			}
			
		}
		tasks.forEach((task) => {
			task.updatePrio()
			task.id=i;
			if(task.score==null || !scores.has(task.score)){
				scores.get(-1).push(task);			
			}
			else{
				scores.get(task.score).push(task);
			}
			i++
			});
		for(var j=7;j>-1;j--){	
			curScore = scores.get(j)
			if(curScore!=null){
				curScore.forEach((task) => {
					updateTask(task,task.id);
				});
			}
		}
	}
	
	function clear_addTask(){
		
		document.getElementById("task").value=""
		document.getElementById("starttime").value=""
		document.getElementById("endtime").value=""
		document.getElementById("category").value=""
		document.getElementById('additiondiv').style.display='none'
	}
	
	function addTask(){
		new StockBuddyTask(
			document.getElementById("task").value,
			document.getElementById("starttime").value,
			document.getElementById("endtime").value,
			document.getElementById("category").value,
			false,
			document.getElementById("uid").value
		)
		clear_addTask()
		displayTasks()
		saveTasks()
	}
	
	function  bodyload(){
		document.getElementById("filterBtn").loseFocus=((btn)=>{
			if(btn.switched){btn.click()}
			console.log(this)
		})
		loadTasks()
	}
	
	function loadTasks(targetlist = "default"){
		var json = localStorage.getItem("StockBuddy_TasklistDB");
		if(json!=null && json!="{}"){
			var objfromjson =JSON.parse(json,reviver);
			var templists = new Map(objfromjson);
			if(lists!=objfromjson){
				console.log(json)
				lists=objfromjson
			}
		}
		if(lists.size!=0){
			if(lists.get(targetlist)==null){
				lists.set(targetlist, []);
			}
			document.getElementById("listname").innerText = targetlist;
			var loadedCodes = lists.get(targetlist)
			tasks=[];
			if(loadedCodes != null){
				loadedCodes.forEach((code) => {
					//text,starttime,endtime,label,state
					new StockBuddyTask(
						code.text,
						code.starttime,
						code.endtime,
						code.label,
						code.state,
						code.creationstamp
					)
				});
			}

		}
		else{
			var loadedCodes = JSON.parse(localStorage.getItem("StockBuddy_Tasklist"));
			if(loadedCodes  != null){
				loadedCodes.forEach((code) => {
					//text,starttime,endtime,label,state
					new StockBuddyTask(
						code.text,
						code.starttime,
						code.endtime,
						code.label,
						code.state,
						code.creationstamp
					)
				});
			}
			saveTasks();
		}
		displayTasks()
	}
	
	function replacer(key, value) {
	  if(value instanceof Map) {
		return {
		  dataType: 'Map',
		  value: Array.from(value.entries()), // or with spread: value: [...value]
		};
	  } else {
		return value;
	  }
	}

	function reviver(key, value) {
	  if(typeof value === 'object' && value !== null) {
		if (value.dataType === 'Map') {
		  return new Map(value.value);
		}
	  }
	  return value;
	}

	function saveTasks(){
		var listjson = JSON.parse(JSON.stringify(tasks));
		lists.set(document.getElementById("listname").innerText,listjson);
		//localStorage.setItem("StockBuddy_Tasklist",JSON.stringify(tasks));
		localStorage.setItem("StockBuddy_TasklistDB",JSON.stringify(lists,replacer));
	}
	setInterval(() => {
		displayTasks();
	  }, 60000);
	</script>
  </body>
</html>
